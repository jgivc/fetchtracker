<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{.Title}}</title>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
            rel="stylesheet"
        />
        <style>
            .file-list {
                max-height: 600px;
                overflow-y: auto;
            }
            .file-item {
                border-bottom: 1px solid #e9ecef;
                padding: 0.75rem 0;
            }
            .file-item:last-child {
                border-bottom: none;
            }
            .torrent-info {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 10px;
                padding: 2rem;
                margin-bottom: 2rem;
            }
            .description-card {
                background: #f8f9fa;
                border-left: 4px solid #007bff;
            }
        </style>
    </head>
    <body class="bg-light">
        <div class="container my-4">
            <!-- Заголовок раздачи -->
            <div class="torrent-info">
                <h1 class="mb-3">
                    <i class="bi bi-cloud-download me-2"></i>
                    {{ .Title }}
                </h1>
                <div class="text-center">
                    <span id="file-count" class="badge bg-success fs-6">
                        <i class="bi bi-files me-1"></i>
                    </span>
                </div>
            </div>

            <!-- Список файлов -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-folder-open me-2"></i>
                        {{ .FilesToDownload }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {{if .Files}}
                    <div class="file-list">
                        {{range $index, $file := .Files}}
                        <div class="file-item px-3" data-file-id="{{$file.ID}}">
                            <div
                                class="d-flex align-items-center justify-content-between"
                            >
                                <div
                                    class="d-flex align-items-center flex-grow-1"
                                >
                                    <i
                                        class="bi bi-file-earmark text-muted me-2"
                                    ></i>
                                    <span class="file-name"
                                        >{{$file.Name}}</span
                                    >
                                </div>
                                <div class="d-flex align-items-center ms-3">
                                    <div class="me-3">
                                        <small class="text-muted"
                                            >{{ DownloadCounter }}:</small
                                        >
                                        <span
                                            class="badge bg-info download-count"
                                            data-file-id="{{$file.ID}}"
                                        >
                                            <i
                                                class="bi bi-hourglass-split"
                                            ></i>
                                        </span>
                                    </div>
                                    <form
                                        method="POST"
                                        action="/file/{{$file.ID}}/"
                                        style="display: inline"
                                    >
                                        <button
                                            type="submit"
                                            class="btn btn-outline-primary btn-sm"
                                        >
                                            <i class="bi bi-download me-1"></i>
                                            {{ .DownloadButton }}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    </div>
                    {{else}}
                    <div class="text-center py-4">
                        <i
                            class="bi bi-folder-x text-muted"
                            style="font-size: 3rem"
                        ></i>
                        <p class="text-muted mt-2">{{ .NoFiles }}</p>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
        <script>
            let updateInterval;
            let isPageVisible = true;

            // Загрузка счетчиков скачиваний
            async function loadDownloadCounts() {
                try {
                    // Добавляем timestamp для обхода кеша
                    // const timestamp = new Date().getTime();
                    // const response = await fetch(`/stat/{{.ID}}/?t=${timestamp}`);
                    const response = await fetch(`/stat/{{.ID}}/`);
                    const data = await response.json();

                    // Обновляем счетчики для каждого файла
                    document
                        .querySelectorAll(".download-count")
                        .forEach((element) => {
                            const fileId = element.getAttribute("data-file-id");
                            const newCount = data[fileId] || 0;
                            const currentCount =
                                parseInt(element.textContent) || 0;

                            // Анимация при изменении счетчика
                            if (newCount !== currentCount) {
                                element.style.transition = "all 0.3s ease";
                                element.style.transform = "scale(1.1)";
                                setTimeout(() => {
                                    element.style.transform = "scale(1)";
                                }, 300);
                            }

                            element.innerHTML = newCount;
                            element.className =
                                newCount > 0
                                    ? "badge bg-success download-count"
                                    : "badge bg-secondary download-count";
                        });

                    // Обновляем время последнего обновления
                    updateLastUpdateTime();
                } catch (error) {
                    console.error("Ошибка загрузки счетчиков:", error);
                    // В случае ошибки показываем индикатор
                    document
                        .querySelectorAll(".download-count")
                        .forEach((element) => {
                            if (
                                !element.textContent ||
                                element.textContent === "0"
                            ) {
                                element.innerHTML = "—";
                                element.className =
                                    "badge bg-warning download-count";
                            }
                        });
                }
            }

            // Обновление времени последнего обновления
            function updateLastUpdateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString();

                let statusElement = document.getElementById("update-status");
                if (!statusElement) {
                    statusElement = document.createElement("div");
                    statusElement.id = "update-status";
                    statusElement.className =
                        "text-muted small mt-2 text-center";
                    document
                        .querySelector(".card-header")
                        .appendChild(statusElement);
                }

                statusElement.innerHTML = `
                <i class="bi bi-arrow-clockwise me-1"></i>
                Последнее обновление: ${timeString}
            `;
            }

            // Управление автообновлением
            function startAutoUpdate(intervalSeconds = 30) {
                if (updateInterval) {
                    clearInterval(updateInterval);
                }

                updateInterval = setInterval(() => {
                    if (isPageVisible) {
                        loadDownloadCounts();
                    }
                }, intervalSeconds * 1000);
            }

            function stopAutoUpdate() {
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }

            // Отслеживание видимости страницы
            document.addEventListener("visibilitychange", () => {
                isPageVisible = !document.hidden;
                if (isPageVisible) {
                    // Страница стала видимой - обновляем счетчики
                    loadDownloadCounts();
                    // Перезапускаем автообновление если оно было остановлено
                    if (!updateInterval) {
                        startAutoUpdate(30);
                    }
                }
            });

            // Инициализация при загрузке страницы
            document.addEventListener("DOMContentLoaded", () => {
                loadDownloadCounts();
                startAutoUpdate(30); // Обновление каждые 30 секунд
                document.getElementById('file-count').textContent = `{{ len .Files }} ${pluralize(["файл", "файла", "файлов"], {{ len .Files }})}`;
            });

            // Обработка кликов по кнопкам скачивания
            document.addEventListener("click", (e) => {
                const downloadButton = e.target.closest(
                    'button[type="submit"]',
                );
                if (
                    downloadButton &&
                    downloadButton.closest('form[action*="/file/"]')
                ) {
                    // Через небольшую задержку обновляем счетчики после клика
                    setTimeout(() => {
                        loadDownloadCounts();
                    }, 1000);
                }
            });
        </script>
    </body>
</html>
