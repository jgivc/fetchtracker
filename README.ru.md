**Русский** | [English](README.md)

# fetchtracker

`fetchtracker` — это приложение для раздачи файлов с подсчетом количества закачек, написанное на Go.

## Основные возможности

*   **Раздача файлов**: Организация файловых "раздач" из папок в указанной директории.
*   **Подсчет скачиваний**: Ведение статистики по количеству скачиваний каждого файла с защитой от накрутки (по cookie или связке IP + User-Agent на 24 часа).
*   **Гибкая шаблонизация**: Возможность кастомизации страниц раздач с помощью пользовательских `index.html`, Markdown-файлов и шаблонизатора Go template.
*   **Интеграция с Nginx**: Эффективная отдача файлов через заголовок `X-Accel-Redirect`, что снижает нагрузку на приложение.
*   **Хранение в Redis**: Сгенерированные страницы и счетчики хранятся в Redis для высокой производительности.
*   **Управление индексацией**: Запуск процесса индексации можно выполнить, отправив сигнал `USR1` процессу, или через специальный URL. При этом используется метод blue-green для бесперебойной работы.
*   **Экспорт счетчиков**: Возможность выгрузить текущие значения счетчиков в JSON-файл по сигналу `USR2`.
*   **Поддержка Docker**: Простое развертывание с помощью Docker Compose.

## Принцип работы

Приложение работает в связке с веб-сервером Nginx. Пользователь создает папки с файлами в рабочем каталоге. Эти папки становятся «раздачами». Процесс индексации, который необходимо запускать вручную, при изменении контента, сканирует эти папки и генерирует для них веб-страницы, сохраняя их вместе со счетчиками в Redis. Ссылка на раздачу представляет собой хеш от пути к папке.

При клике на ссылку «скачать» приложение получает POST-запрос, увеличивает счетчик и отдает Nginx специальный заголовок (по умолчанию `X-Accel-Redirect`) с реальным путем к файлу. После этого Nginx самостоятельно отдает файл пользователю, что минимизирует нагрузку на приложение.

## Установка и запуск

### Метод 1: Быстрый запуск.

1.  Убедитесь, что у вас установлены Docker и make
2.  Запустите контейнеры с помощью команды
    ```bash
    make run
    ```
    Команда создаст каталог с тестовыми данными в каталоге `/tmp/testdata` и запустит контейнеры.
3.  Запустите процесс индексации по адресу http://localhost/index/ по умолчанию
4.  После создания индекса отобразятся ссылки на раздачи.

Также контейнеры можно запустить командой
```bash
SHARE_PATH=/path/to/folders docker compose -f deploy/docker-compose.yml up --build
```
указав в переменной `SHARE_PATH` путь к вашим папкам.


### Метод 2: Ручная установка

1.  Получите бинарный дистрибутив приложения.
  Скачайте готовый бинарник или соберите его самостоятельно:
  1.  Убедитесь, что у вас установлен Go.
  2.  Соберите приложение с помощью Make:
      ```bash
      make build
      ```
2.  Установите redis или получите настройки доступа к существующему экземпляру.
3.  Создайте ваши папки с раздачами
4.  Создайте файл конфигурации `config.yml` с соответствующими настройками.
5.  Запустите приложение:
    ```bash
    ./fetchtracker -f config.yml
    ```
6. Запустите процесс индексации и получите адреса раздач.

## Конфигурация

Настройки приложения задаются в YAML-файле (`config.yml`). Вот пример со всеми доступными параметрами:

```yaml
# Порт, на котором слушает приложение
listen: :10011
# URL для подключения к Redis
redis: redis://localhost/0
log_level: info
indexer:
  # Рабочий каталог, где находятся папки с раздачами
  work_dir: /data/
  # Количество потоков для индексации
  workers: 2
  # Имя файла для пользовательского шаблона страницы раздачи
  index_filename: index.html
  # Имя файла с описанием в формате Markdown
  desc_filename: description.md
  # Имя файла-шаблона для вставки контента из Markdown
  template_filename: template.html
  # Путь к шаблону index.html по умолчанию (если используется)
  index_template: ""
  # Путь к шаблону template.html по умолчанию (если используется)
  md_template: ""
  # Список файлов, которые будут проигнорированы при индексации
  skip_files:
  - description.md
  # Файл для выгрузки счетчиков по сигналу USR2
  dump_filename: /tmp/fetchtracker_counters.json
handler:
  # Адрес, который будет использоваться для генерации ссылок на раздачи
  url: http://127.0.0.1
  # Заголовок для перенаправления на nginx
  header_redirect: X-Accel-Redirect
  # Заголовок, из которого будет браться реальный IP пользователя
  header_realip: X-Real-IP
```

## Использование

### Создание раздач

Чтобы создать раздачу, просто создайте новую папку в директории, указанной в `work_dir` в файле конфигурации. После запуска индексации для этой папки будет сгенерирована страница.

### Шаблонизация

Индексатор определяет, какой HTML-шаблон использовать для генерации страницы раздачи, по следующим правилам:

1.  Если в папке раздачи есть файл `index.html` (имя настраивается в `index_filename`), используется он.
2.  Если в папке нет файла `description.md` (имя настраивается в `desc_filename`), используется шаблон по умолчанию (`index_template` или встроенный).
3.  Если в папке есть и `template.html` (`template_filename`), и `description.md`, то контент из `description.md` преобразуется из Markdown и вставляется в `template.html`.
4.  Если в папке есть только `description.md`, он преобразуется и вставляется в шаблон по умолчанию (`md_template` или встроенный).

### Использование Markdown

В файлах `description.md` можно использовать специальный синтаксис для ссылок и метаданные Frontmatter.

#### Синтаксис ссылок

*   `[[test.txt]]`: Генерирует ссылку на файл `test.txt`.
*   `[[test.txt|Описание]]`: Генерирует ссылку на файл с текстом "Описание".
*   `[[FILES]]`: Вставляет список ссылок на все файлы в раздаче.

#### Frontmatter

В начале markdown-файла можно указать блок с метаданными в формате YAML для управления отображением раздачи.

**Пример:**

```markdown
---
title: Моя раздача
enabled: true
files: {
    file1.img: Описания для первого файла
}
---

Здесь можно разместить любое описание.

[[FILES]]
```

*   `title`: Заменяет имя папки в заголовке страницы.
*   `enabled`: `true` или `false`, включает или отключает раздачу.
*   `files`: Объект, где ключ — имя файла, а значение — его описание, которое будет отображаться в списке файлов.

В шаблоны передается структура `entity.Download`
Также можно переопределить именованные шаблоны FILE и FILES, которые используются для отображения файла и файлов соответственно.
Примеры шаблонов можно посмотреть в каталоге `internal/adapter/fsadapter/templates`

## Конфигурация Nginx

Для корректной работы требуется настроить Nginx в качестве обратного прокси.

**Пример конфигурации:**

```nginx
server {
    listen 80;

    # Раздачи
    location /share/ {
        try_files false @backend;
    }

    # Отсюда подгружаются счетчики (статистика в JSON)
    location /stat/ {
        try_files false @backend;
    }

    # Скачивание файла
    location /file/ {
        try_files false @backend;
    }

    # Индексация. ЭТОТ LOCATION НЕОБХОДИМО ЗАКРЫТЬ ОТ ВНЕШНЕГО ДОСТУПА!
    location /index/ {
        # allow 127.0.0.1;
        # deny all;
        try_files false @backend;
    }

    # Внутренний location, указывающий на реальный путь к файлам раздач.
    # Путь /data/ должен соответствовать work_dir из конфига приложения.
    location /data/ {
        internal;
        alias /data/;
    }

    location @backend {
        # Заголовки для отключения кэширования
	    add_header 'Cache-Control' 'no-cache, no-store, must-revalidate';
    	add_header 'Pragma' 'no-cache';
    	add_header 'Expires' '0';

        proxy_pass http://app:10011; # Адрес Go-приложения
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## Разработка

В проекте используется `Makefile` для автоматизации основных задач.

*   `make build`: Сборка бинарного файла приложения `fetchtracker`.
*   `make testdata`: Создание тестовых папок и файлов в каталоге `/tmp/testdata` для отладки и тестирования.
*   `build-all`: сборка для всех платформ
*   `release`: создание релизных архивов
*   `clean`: очистка
*   `run`: запуск через Docker
